% Pruebas para el sistema AmboVent UVG + HUMANA
% Luis Alberto Rivera

%% Perfiles de posición y velocidad originales
% pos = [  0,  0,  0,  0,  1,  1,  1,  2,  2,  3,  3,  4,  5,  5,  6,  7,  8,  9, 10, 11,...
%         12, 14, 15, 16, 17, 19, 20, 22, 23, 25, 27, 28, 30, 32, 33, 35, 37, 39, 41, 43,...
%         45, 47, 49, 51, 53, 55, 57, 59, 62, 64, 66, 68, 71, 73, 75, 78, 80, 82, 85, 87,...
%         90, 92, 95, 97,100,102,105,107,110,112,115,117,120,122,125,128,130,133,135,138,...
%        140,143,145,148,150,153,155,158,160,163,165,168,170,173,175,177,180,182,184,187,...
%        189,191,193,196,198,200,202,204,206,208,210,212,214,216,218,220,222,223,225,227,...
%        228,230,232,233,235,236,238,239,240,241,243,244,245,246,247,248,249,250,250,251,...
%        252,252,253,253,254,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,...
%        255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,...
%        255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,...
%        255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,...
%        255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,...
%        255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,254,254,254,253,...
%        253,252,252,251,250,250,249,248,248,247,246,245,244,243,242,241,239,238,237,236,...
%        234,233,232,230,229,227,225,224,222,220,219,217,215,213,211,209,207,205,203,201,...
%        199,197,195,193,191,188,186,184,182,179,177,175,172,170,167,165,163,160,158,155,...
%        153,150,148,145,143,140,138,135,133,130,128,125,123,120,118,115,113,110,108,105,...
%        103,101, 98, 96, 94, 91, 89, 87, 85, 83, 80, 78, 76, 74, 72, 70, 68, 66, 65, 63,...
%         61, 59, 58, 56, 54, 53, 51, 50, 48, 47, 46, 45, 43, 42, 41, 40, 39, 38, 37, 36,...
%         35, 34, 33, 32, 31, 31, 30, 29, 28, 27, 26, 26, 25, 24, 23, 22, 22, 21, 20, 20,...
%         19, 18, 18, 17, 16, 16, 15, 15, 14, 14, 13, 13, 12, 12, 11, 11, 10, 10,  9,  9,...
%          9,  8,  8,  7,  7,  7,  6,  6,  6,  5,  5,  5,  5,  4,  4,  4,  4,  3,  3,  3,...
%          3,  3,  3,  2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,...
%          1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,...
%          0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0];
     
% vel = [129,129,130,130,131,131,132,133,133,134,135,135,136,136,137,138,138,138,139,140,...
%        140,141,141,141,142,142,143,143,144,144,145,145,145,146,146,146,147,147,147,148,...
%        148,148,149,149,149,150,150,150,150,151,151,151,151,151,152,152,152,152,152,152,...
%        153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,...
%        153,153,153,153,153,153,153,153,153,153,152,152,152,152,152,152,151,151,151,151,...
%        151,150,150,150,150,149,149,149,148,148,148,147,147,147,146,146,146,145,145,145,...
%        144,144,143,143,142,142,141,141,141,140,140,139,138,138,138,137,136,136,135,135,...
%        134,133,133,132,131,131,130,130,129,129,128,128,128,128,128,128,128,128,128,128,...
%        128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
%        128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
%        128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
%        128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
%        128,128,128,128,128,128,128,128,128,128,128,127,127,126,126,126,125,125,124,124,...
%        123,123,122,122,121,121,120,120,120,119,118,118,118,117,117,116,116,115,115,115,...
%        114,114,113,113,113,112,112,111,111,111,110,110,109,109,109,108,108,108,107,107,...
%        107,107,106,106,106,105,105,105,105,105,104,104,104,104,104,104,103,103,103,103,...
%        103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,104,104,104,104,...
%        104,105,105,105,105,105,106,106,106,107,107,107,108,108,108,109,109,109,110,110,...
%        111,111,112,112,113,113,114,114,114,115,116,116,116,117,117,118,118,118,118,118,...
%        119,119,119,119,119,119,119,120,120,120,120,120,120,120,121,121,121,121,121,121,...
%        121,122,122,122,122,122,122,122,123,123,123,123,123,123,123,124,124,124,124,124,...
%        124,124,124,124,125,125,125,125,125,125,125,125,125,126,126,126,126,126,126,126,...
%        126,126,126,126,126,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,...
%        127,127,127,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
%        128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128];

%% Perfiles de posición y velocidad nueva versión
pos = [  0,  0,  1,  2,  4,  6,  8, 10, 13, 15, 18, 21, 25, 28, 31, 35, 38, 42, 46, 50,...
        54, 57, 61, 66, 70, 74, 78, 82, 86, 91, 95, 99,104,108,112,117,121,125,130,134,...
       138,143,147,151,156,160,164,169,173,177,181,185,189,194,198,201,205,209,213,217,...
       220,224,227,230,234,237,240,242,245,247,249,251,253,254,255,255,255,255,255,255,...
       255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,...
       255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,...
       255,255,255,255,255,255,255,254,253,252,250,248,246,244,241,238,235,232,229,225,...
       222,218,214,210,206,202,198,193,189,184,180,175,171,166,162,157,152,148,143,138,...
       134,129,124,120,115,111,106,102, 97, 93, 89, 84, 80, 76, 72, 68, 64, 61, 57, 54,...
        50, 47, 44, 41, 38, 36, 33, 31, 29, 27, 25, 23, 22, 20, 19, 17, 16, 15, 13, 12,...
        11, 10,  9,  8,  7,  6,  6,  5,  4,  3,  3,  2,  2,  1,  1,  1,  0,  0,  0,  1,...
         1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,...
         1,  1,  1,  0,  0,  0,  0,  0,  0,  0]';

vel = [129,132,134,136,137,139,140,141,142,143,143,144,144,145,146,146,146,147,147,147,...
       148,148,148,148,149,149,149,149,149,149,150,150,150,150,150,150,150,150,150,150,...
       150,150,150,150,150,149,149,149,149,149,149,148,148,148,148,147,147,147,146,146,...
       146,145,144,144,143,143,142,141,140,139,137,136,134,132,129,128,128,128,128,128,...
       128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
       128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,...
       128,128,128,128,128,127,125,123,121,120,119,117,116,115,114,113,112,111,111,110,...
       109,109,108,108,107,107,106,106,106,106,105,105,105,105,105,105,105,105,105,105,...
       105,105,105,105,105,105,106,106,106,107,107,107,108,108,109,109,110,110,111,111,...
       112,113,113,114,115,116,117,118,118,119,119,120,120,120,121,121,121,122,122,122,...
       123,123,123,124,124,124,124,125,125,125,125,125,126,126,126,126,126,127,127,127,...
       127,127,127,127,128,128,128,128,128,128,128,128,128,128,128,128,129,129,129,129,...
       129,129,129,129,129,128,128,128,128,128]';


figure(1); clf;
subplot(2,1,1);
plot(pos);
xlabel('Index');
ylabel('Promiles of full range');
title('Position');
grid on;
subplot(2,1,2);
plot(vel-128);
% plot(diff(pos));
xlabel('Index');
ylabel('position change per 0.2 sec');
title('Velocity');
grid on;
sgtitle('Position and Velocity Profiles of AmboVent System');

%% BPM, motion time, etc.
profile_length = length(pos);
cycleTime = 10;  % en milis
motion_time = 35;  % in 100 ms --> el tiempo real es motion_time*100 ms
                   % se restringe entre 25 y 50, i.e, entre 2.5 y 5.0 seg

%A_freq = analogRead(pin_FRQ); % Debería estar entre 0 y 1023
A_freq = (0:1023)';
% BPM = floor(6 + (A_freq - 23)/55);  % inicial: 14, rango entre 6 y 30 (según imagen en el pdf)
BPM = floor(6 + 24*A_freq/1023);
breath_cycle_time = 60000./BPM + 100;
wanted_cycle_time = 100*(motion_time/profile_length)*ones(size(breath_cycle_time));

indtemp = wanted_cycle_time > breath_cycle_time/profile_length;
wanted_cycle_time(indtemp) = breath_cycle_time(indtemp)/profile_length;

figure(2); clf;
subplot(3,1,1);
plot(A_freq, BPM);
xlim([min(A_freq), max(A_freq)]);
xlabel('Valor del analogRead');
ylabel('BPM');
grid on;
subplot(3,1,2);
scatter(BPM, breath_cycle_time, 'filled');
xlim([min(BPM), max(BPM)]);
xticks(min(BPM):max(BPM));
xlabel('BPM');
ylabel('wanted cycle time (ms)');
grid on;
subplot(3,1,3);
scatter(BPM, wanted_cycle_time, 'filled');
xlim([min(BPM), max(BPM)]);
xticks(min(BPM):max(BPM));
xlabel('BPM');
ylabel('Ciclo completo (s)');
grid on;
sgtitle(sprintf('Variable cycleTime = %d,   motion time = %d', cycleTime, motion_time));


%% Pruebas para el vector de ajuste de volumen:
perc_of_lower_volume = 30;
perc_of_lower_vol_display = 30;
Compression_perc = floor(linspace(perc_of_lower_vol_display,100,10));
min_arm_pos = 150; max_arm_pos = 600;

range_factor = perc_of_lower_volume + ...
                      (Compression_perc - perc_of_lower_vol_display)*...
                           (100 - perc_of_lower_volume)/(100 - perc_of_lower_vol_display);
range_factor = range_factor/100;

if(range_factor > 1)
    range_factor = 1;
end

if(range_factor < 0)
    range_factor = 0;
end

range = range_factor*(max_arm_pos - min_arm_pos);
N = length(Compression_perc);

ajuste = [1 1 1 1 1 1 1 1 1 1];
ajuste = repmat(ajuste,profile_length,1);
wanted_pos = ajuste.*(pos*range)/255 + min_arm_pos;

figure(3); clf;
plot(wanted_pos(:, N));
xlabel('Index');
ylabel('Pot clicks');
title('wanted\_pos para diversos Compression\_perc');
grid on;
hold on;

for n = (N-1):-1:1
    plot(wanted_pos(:,n));
end
legend(string(Compression_perc(N:-1:1)));
